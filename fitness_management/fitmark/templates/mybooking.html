{% extends "base.html" %}
{% block title %}My Booking{% endblock %}
{% block nav %}{% include "navbar.html" %}{% endblock %}
{% block content %}
    <!-- Class Booking Section -->
    <section class="max-w-5xl mx-auto p-6">
        <h2 class="text-4xl font-bold text-accent mb-4">การจองของฉัน</h2>

        {% for booking in bookings %}
        <!-- Class Cards -->
        <div class="p-6 bg-gray-800 rounded-lg shadow-lg flex justify-between items-center mb-6">
            <div class="flex items-center space-x-4">
                <img src="{{ booking.schedule.class_instacne.image}}" alt="{{ booking.schedule.class_instacne.image}}" class="w-28 h-28 rounded-full object-cover">
                <div>
                    <h3 class="text-secondary text-2xl font-semibold">{{ booking.schedule.class_instacne.name}}</h3>
                    <p class="text-gray-400">{{ booking.schedule.class_instacne.detail}}</p>
                    <p class="text-white py-2">{{ booking.schedule.class_instacne.trainer}}</p>
                </div>
            </div>
            <div class="flex flex-col items-center text-lg">
                <span class="text-primary mb-2">
                    {{ booking.schedule.date|date:"d F Y" }}
                    ({{ booking.schedule.start_time|time:"H:i" }} - 
                    {{ booking.schedule.end_time|time:"H:i" }})
                </span>
                <button class="bg-red-400 text-2xl text-white font-bold py-2 px-16 rounded-3xl hover:bg-red-500"
                    onclick="cancelBooking({{ booking.id }})">
                    ยกเลิกการจอง
                </button>
            </div>
        </div>
        {% empty %}
        <div class="text-center text-2xl text-gray-400">ไม่มีการจอง</div>
        {% endfor %}
    </section>

    <!-- Delete Class Modal -->
    <dialog id="delete_booking_modal" class="modal">
        <div class="modal-box bg-gray-800 w-full max-w-2xl">
          <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
          </form>

          <form>
            {% csrf_token %}

            <input type="hidden" id="delete_booking_id" name="booking_id" value=""/>

            <h2 class="text-center text-3xl font-semibold text-primary mb-2">คุณแน่ใจหรือไม่ที่จะยกเลิกการจองนี้</h2>
    
            <!-- Confirm button -->
            <div class="flex justify-center mt-7">
            <button onclick="deleteBooking('{{ csrf_token }}')"
                class="w-1/3 bg-red-400 text-white text-xl font-bold py-3 rounded-lg hover:bg-red-500 focus:outline-none transition-colors duration-300 mx-auto">
                ยืนยัน
            </button>
            </div>
    
          </form>
        </div>
    </dialog>
{% endblock %}
{% block script %}
    <script>
        function cancelBooking(id) {
            // เปิด modal
            const deleteModal = document.getElementById('delete_booking_modal');
            deleteModal.showModal();
            
            // ตั้งค่าฟิลด์ฟอร์มให้มีค่าเท่ากับข้อมูลของคลาสนั้น ๆ
            document.getElementById('delete_booking_id').value = id;
        }

        function deleteBooking(csrf_token) {

            const booking_id = document.getElementById('delete_booking_id').value;
    
            // กำหนด path ให้ถูกต้อง
            fetch(`/MyBooking/delete/${booking_id}/`, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrf_token,
              },
            })
            .then(response => {
                if (response.ok) {
                    const modal = document.getElementById('delete_booking_modal');
                    modal.close();
                    window.location.reload();
                }
            })
            .catch((error) => console.error("Error:", error));
        }

    </script>
{% endblock %}