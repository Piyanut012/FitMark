{% extends "base.html" %}
{% block title %}Booking{% endblock %}
{% block CSS %}
<style>

    .flatpickr-calendar.inline {
        top: 0.75rem;
        left: 2rem;
    }
    .flatpickr-calendar {
        border: 1px var(--flatpickr-border-color, #FF79C6);
        border-radius: var(--flatpickr-border-radius, 0.5rem);
    }
     .flatpickr-weekdays span {
        font-weight: bold;
    }
    .flatpickr-day{
        color: #FF79C6;
        font-weight: bold;
    }
    .flatpickr-day.selected, .flatpickr-day:hover, .flatpickr-day.selected:hover {
        background-color: #FF79C6; 
        color: #ffffff;
        border: none;
    }
    .flatpickr-day.flatpickr-disabled, .flatpickr-day.flatpickr-disabled:hover {
        color: #9ca3af; 
    }
    .flatpickr-day:nth-child(n+36) {
        display: none;
    }
    
</style>
{% endblock %}
{% block nav %}{% include "navbar.html" %}{% endblock %}
{% block content %}
    <!-- Class Booking Section -->
    <section class="max-w-5xl mx-auto p-6">
        <h2 class="text-4xl font-bold text-accent mb-4">จองคลาส</h2>

        {% for class in classes %}
        <!-- Class Cards -->
        <div class="p-6 bg-gray-800 rounded-lg shadow-lg flex justify-between items-center mb-6">
            <!-- Class Info -->
            <div class="flex items-center space-x-6">
                <!-- Class Image -->
                <img src="{{ class.image }}" alt="{{ class.name }}" class="w-32 h-32 rounded-full object-cover">
                <!-- Class Details -->
                <div>
                    <h3 class="text-secondary text-2xl font-semibold">{{ class.name }}</h3>
                    <p class="text-gray-400 mt-2">{{ class.detail }}</p>
                    <p class="text-white font-medium mt-4">{{ class.trainer }}</p>
                </div>
            </div>
            
            <!-- Booking and Price -->
            <div class="flex flex-col items-center">
                <!-- Booking Button -->
                <button class="bg-primary text-2xl text-white font-bold py-3 px-24 rounded-full hover:bg-pink-500 transition duration-300 ease-in-out"
                    onclick="openScheduleModal({{ class.id }})">
                    จอง
                </button>
                <!-- Price -->
                <span class="text-accent mt-3 text-lg">{{ class.price }} บาท</span>
            </div>
        </div>

        {% empty %}
        <div class="text-center text-2xl text-gray-400">ไม่มีคลาส</div>
        {% endfor %}

    </section>

    <!-- Booking Class Modal -->
    <dialog id="book_class_modal" class="modal">
        <div class="modal-box bg-gray-800 w-full max-w-3xl">
          <form method="dialog">
            <button onclick="closeScheduleModal()" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" >✕</button>
          </form>

          <form id="book_class_form" action="{% url 'add_book_class' %}" method="POST">
            {% csrf_token %}
            
            <!-- Select datetime -->
            <div class="p-2 border-b-2 border-secondary mt-3">
                <span class="text-2xl">เลือกวันและเวลา</span>
            </div>

            <div class="grid md:grid-cols-2 md:gap-4 text-gray-400 mb-4">
                {% comment %} <div id="datepicker-inline" class=" p-5 rounded-lg"></div> {% endcomment %}
                <div id="datepicker-inline" class="hidden"></div>
                <div class="ml-6 p-5">
                    <div class="flex justify-between items-center">
                        <h4 id="date_detail" class=" text-white mb-2"></h4>
                    </div>
                    <div id="schedule-list" class="space-y-2 mt-3">
    
                    </div>
                </div>
            </div>
            <!-- Comfirm up button -->
            <div class="flex justify-center mt-7">
            <button id="book-button" type="submit"
                class="hidden w-1/3 bg-green-400 text-white text-xl font-bold py-3 rounded-lg hover:bg-green-500 focus:outline-none transition-colors duration-300 mx-auto">
                จอง
            </button>
            </div>
           </form>
        </div>
    </dialog>

{% endblock %}

{% block script %}
<script>
    function openScheduleModal(classId) {

        // ดึงข้อมูล schedule ของคลาสจาก backend
        fetch(`/BookClass/${classId}/`)
        .then(response => response.json())
        .then(data => {
            function formatDateToISO(date) {
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0'); // เดือนเริ่มต้นจาก 0
                const day = String(date.getUTCDate()).padStart(2, '0');
                return `${year}-${month}-${day}`; // รูปแบบ YYYY-MM-DD
            }
            // เก็บวันที่ที่มี schedule ลงใน highlightedDates
            const enableDates = Array.from(new Set(data.map(schedule => formatDateToISO(new Date(schedule.date)))));
    
            // ตั้งค่า flatpickr และ highlight วันที่
            const datepicker = flatpickr("#datepicker-inline", {
                inline: true,
                locale: "th",
                dateFormat: "Y-m-d",
                enable: enableDates,
                onChange: function(selectedDates) {

                    // แสดงปุ่มจองเมื่อเลือกวันที่
                    const bookButton = document.getElementById('book-button');
                    bookButton.classList.remove('hidden');
  
                    // แปลง YYYY-MM-DD
                    const selectedDateOriginal = selectedDates.length > 0 ? selectedDates[0] : '';
                    const year = selectedDateOriginal.getFullYear();
                    const month = String(selectedDateOriginal.getMonth() + 1).padStart(2, '0');
                    const day = String(selectedDateOriginal.getDate()).padStart(2, '0');
                    const selectedDate = `${year}-${month}-${day}`;
                    
                    // ดึงข้อมูล schedule ของวันที่ที่เลือกจาก data
                    const schedulesForSelectedDate = data.filter(schedule => schedule.date === selectedDate);
                    
                    // แสดง schedule ใน element ที่ต้องการ
                    let scheduleOptions = '';
                    schedulesForSelectedDate.forEach(schedule => {
                        console.log(schedule);
                        scheduleOptions += `
                            <option value="${schedule.id}">${schedule.start_time}-${schedule.end_time} จอง ${schedule.booked_seats}/${schedule.capacity}</option>
                        `;
                    });

                    // อัปเดตเนื้อหาใน modal
                    document.getElementById('schedule-list').innerHTML = `
                        <select class="select select-primary w-full max-w-xs bg-gray-800 border-1 text-white" name="schedule_id">
                            <option disabled selected>เลือกเวลา</option>
                            ${scheduleOptions}
                        </select>
                    `;
    
                    // อัปเดตรายละเอียดวันที่ที่เลือก
                    const formattedDate = selectedDates.length > 0
                        ? selectedDates[0].toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
                        : '';
                    document.getElementById('date_detail').textContent = formattedDate;
                }
            });
    
            // แสดง modal หลังจากโหลดข้อมูลเรียบร้อย
            const modal = document.getElementById('book_class_modal');
            modal.showModal();
        })
        .catch(error => console.error('Error fetching schedule data:', error));
    }

    function closeScheduleModal() {
        window.location.reload();
    }

    document.getElementById('book_class_form').addEventListener('submit', function (event) {
        event.preventDefault();
    
        const formData = new FormData(this);
    
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeScheduleModal();
            }
        })
        .catch(error => console.error('Error:', error));
    });

</script>

{% endblock %}
